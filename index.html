<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Desert Racing Game - Full Version</title>
<style>
body { margin:0; overflow:hidden; background-color:#333; font-family:Arial,sans-serif; color:white; text-align:center; }
canvas { display:block; margin:20px auto; }
.car-choice, .dealership { display:flex; justify-content:center; margin-top:20px; flex-wrap:wrap; }
.car-choice button, .dealership button, #creditsBtn { margin:5px; padding:10px; cursor:pointer; font-size:16px; }
#coinDisplay { font-size:20px; margin:10px; }
</style>
</head>
<body>

<h1>Choose Your Car</h1>
<div class="car-choice" id="carChoice">
    <button onclick="selectCar('red')">Red</button>
    <button onclick="selectCar('blue')">Blue</button>
    <button onclick="selectCar('green')">Green</button>
    <button onclick="selectCar('yellow')">Yellow</button>
    <button onclick="selectCar('purple')">Purple</button>
</div>

<div id="coinDisplay" style="display:none;">Coins: 0</div>
<div class="dealership" id="dealership" style="display:none;"></div>

<!-- Credits button -->
<div style="text-align:center; margin-top:10px;">
    <button id="creditsBtn">Credits</button>
</div>

<canvas id="gameCanvas" width="400" height="600" style="display:none;"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let gameStarted=false, score=0, gameSpeed=5, level=1, coins=parseInt(localStorage.getItem('coins')) || 0;
let purchasedCars = JSON.parse(localStorage.getItem('purchasedCars')) || ['red','blue'];
const keys={};
document.addEventListener('keydown', e=>keys[e.key]=true);
document.addEventListener('keyup', e=>keys[e.key]=false);

// Images
const carImages={
    red:'https://i.imgur.com/7Q3X3dK.png',
    blue:'https://i.imgur.com/8F0Gd1s.png',
    green:'https://i.imgur.com/EQ9lW3J.png',
    yellow:'https://i.imgur.com/1fVjHlb.png',
    purple:'https://i.imgur.com/yHfTqSt.png'
};
const obstacleImages={
    cactus:'https://i.imgur.com/qeWxVfP.png',
    rock:'https://i.imgur.com/3KfbXc2.png',
    traffic:'https://i.imgur.com/0r7X6Ub.png'
};

// Lanes
const lanes=[canvas.width/4 +10, canvas.width/2 -25, canvas.width*3/4 -60];

// Player car
let carColor='red';
let car={x:lanes[1], y:canvas.height-120, width:50, height:100, img:new Image(), speed:5};
car.img.src = carImages[carColor];

// Obstacles
const obstacles=[];

// Road lines
const roadLines=[];
for(let i=0;i<20;i++) roadLines.push({x:canvas.width/2-5, y:i*60, width:10, height:40});

// Traffic lights
function createTrafficLight(laneIndex){
    const img = new Image();
    img.src=obstacleImages.traffic;
    const state=Math.random()<0.5?'red':'green';
    return {x:lanes[laneIndex], y:-50, width:50, height:50, img:img, state:state, timer:0};
}

// Car selection
function selectCar(color){
    if(!purchasedCars.includes(color)) { alert("You don't own this car! Buy it first."); return; }
    carColor=color;
    car.img.src=carImages[carColor];
    document.querySelector('h1').style.display='none';
    document.getElementById('carChoice').style.display='none';
    document.getElementById('coinDisplay').style.display='block';
    document.getElementById('dealership').style.display='flex';
    canvas.style.display='block';
    gameStarted=true;
    gameLoop();
    updateDealership();
}

// Draw background with levels
function drawBackground(){
    let bgColors;
    if(level===1) bgColors=['#f4e2b3','#d9b382'];
    else if(level===2) bgColors=['#fcd28f','#c99963'];
    else if(level===3) bgColors=['#f4b37b','#d98a5b'];
    else bgColors=['#e27f5d','#b85a3f'];

    const gradient = ctx.createLinearGradient(0,0,0,canvas.height);
    gradient.addColorStop(0,bgColors[0]);
    gradient.addColorStop(1,bgColors[1]);
    ctx.fillStyle=gradient;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle='#555';
    ctx.fillRect(canvas.width/4,0,canvas.width/2,canvas.height);

    ctx.fillStyle='white';
    roadLines.forEach(line => ctx.fillRect(line.x,line.y,line.width,line.height));

    ctx.fillStyle='rgba(255,255,255,0.2)';
    ctx.font='bold 200px Arial';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText('67',canvas.width/2,canvas.height/2);
}

function updateRoadLines(){
    roadLines.forEach(line=>{
        line.y+=gameSpeed;
        if(line.y>canvas.height) line.y=-40;
    });
}

function drawCar(){ ctx.drawImage(car.img, car.x, car.y, car.width, car.height); }

function drawObstacles(){ 
    obstacles.forEach(ob => {
        ctx.drawImage(ob.img, ob.x, ob.y, ob.width, ob.height);
        if(ob.state){
            ctx.fillStyle = ob.state==='red'?'red':'green';
            ctx.beginPath();
            ctx.arc(ob.x+ob.width/2, ob.y+10,8,0,Math.PI*2);
            ctx.fill();
        }
    });
}

function updateObstacles(){
    obstacles.forEach(ob=>{
        ob.y+=gameSpeed;
        if(ob.state){ ob.timer++; if(ob.timer>120){ ob.state=ob.state==='red'?'green':'red'; ob.timer=0; } }
    });

    for(let i=obstacles.length-1;i>=0;i--){
        if(obstacles[i].y>canvas.height){ obstacles.splice(i,1); score+=1; }
    }

    if(Math.random()<0.02+0.01*level){
        const laneIndex=Math.floor(Math.random()*3);
        const types=['cactus','rock','traffic'];
        const type=types[Math.floor(Math.random()*types.length)];
        if(type==='traffic') obstacles.push(createTrafficLight(laneIndex));
        else{
            const img = new Image(); img.src = obstacleImages[type];
            obstacles.push({x:lanes[laneIndex], y:-50, width:50, height:50, img:img});
        }
    }
}

function detectCollision(){
    for(let ob of obstacles){
        if(car.x<ob.x+ob.width && car.x+car.width>ob.x && car.y<ob.y+ob.height && car.y+car.height>ob.y){
            if(ob.state==='red') return true;
            if(ob.state==='green'){ coins+=5; updateCoinDisplay(); } 
            else return true;
        }
    }
    return false;
}

function update(){
    // Lane switching
    if(keys['ArrowLeft']){ const idx=lanes.indexOf(lanes.reduce((p,c)=>Math.abs(car.x-c)<Math.abs(car.x-p)?c:p)); if(idx>0) car.x-=5; }
    if(keys['ArrowRight']){ const idx=lanes.indexOf(lanes.reduce((p,c)=>Math.abs(car.x-c)<Math.abs(car.x-p)?c:p)); if(idx<lanes.length-1) car.x+=5; }

    updateRoadLines();
    updateObstacles();

    gameSpeed=5+Math.floor(score/10);
    if(detectCollision()){ 
        alert(`Game Over! Score: ${score} | Level: ${level} | Coins: ${coins}`); 
        localStorage.setItem('coins',coins); 
        localStorage.setItem('purchasedCars',JSON.stringify(purchasedCars));
        document.location.reload(); 
    }

    // Level progression every 20 points
    const newLevel = 1 + Math.floor(score/20);
    if(newLevel>level){ coins+=10; updateCoinDisplay(); } // reward coins for leveling up
    level = newLevel;
}

function drawScore(){ ctx.fillStyle='white'; ctx.font='20px Arial'; ctx.fillText(`Score: ${score}  Level: ${level}`,10,30); }

function updateCoinDisplay(){ document.getElementById('coinDisplay').innerText=`Coins: ${coins}`; }

// Dealership
function updateDealership(){
    const shop = document.getElementById('dealership');
    shop.innerHTML='';
    for(const color in carImages){
        if(purchasedCars.includes(color)){
            const btn=document.createElement('button');
            btn.innerText=`${color} (Owned)`;
            btn.onclick=()=>{ selectCar(color); };
            shop.appendChild(btn);
        } else {
            const price=20;
            const btn=document.createElement('button');
            btn.innerText=`Buy ${color} - ${price} coins`;
            btn.onclick=()=>{
                if(coins>=price){ coins-=price; purchasedCars.push(color); localStorage.setItem('purchasedCars',JSON.stringify(purchasedCars)); updateCoinDisplay(); updateDealership(); alert(`${color} purchased!`); }
                else alert('Not enough coins');
            };
            shop.appendChild(btn);
        }
    }
}

// Credits button
document.getElementById('creditsBtn').onclick = () => {
    alert('bestman360 smells ðŸ˜Ž');
}

function gameLoop(){
    if(!gameStarted) return;
    drawBackground();
    update();
    drawCar();
    drawObstacles();
    drawScore();
    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>